# 개인프로젝트 리드미

# 1. 어떻게 사진 확대를 자연스럽게 할 수 있을까?

# 유클리드 거리 공식으로 색상 간의 유사성을 정량적으로 계산

### 색상의 유사성을 어떻게 알 수 있을까?

색상을 표현하는 많은 방법 중 R, G, B 수치로 나타내는 방법이 있습니다. 각각의 R, G, B 값은 0부터 255까지 있으며, R, G, B를 축으로 해서 3차원으로 표현하면 오른쪽 그림과 같이 표현될 수 있습니다. 이렇게 3차원 공간에서 R, G, B를 표현해보면 가까이에 있는 지점의 색상이 비슷하다는 것을 유추할 수 있었습니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/8a1a73de-1c89-41f1-a31c-81f2196d90ec/Untitled.png)

### 유클리드 거리 공식을 이용해 색상의 유사성 계산

색상이 비슷하다는 것은, RGB 3차원 공간에서 서로의 거리가 가깝다는 것을 의미합니다. 이 사실을 활용하기 위해서 아래의 유클리드 거리 공식을 사용했습니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/5625bbfd-4825-4e83-a6c7-0bc6ded230a1/Untitled.png)

실제 코드에서는 아래와 같이 구현했습니다.

```jsx
const calculateDistance = (rgb1, rgb2) => {
  const [r1, g1, b1] = rgb1;
  const [r2, g2, b2] = rgb2;

  return Math.sqrt(
    Math.pow(r2 - r1, 2) + Math.pow(g2 - g1, 2) + Math.pow(b2 - b1, 2),
  );
};
```

두 색상 벡터 사이의 공간적 거리를 나타내는 실수 값을 반환하게 됩니다. RGB 색상 공간에서 두 색상 사이의 거리를 비교해서 가장 가까운 색을 찾는데 사용했습니다.

# MongoDB내 사진을 탐색하는 알고리즘 구현

클라이언트에서 보낸 target 색상값과 가장 유클리드 거리가 가까운 색상을 가진 사진을 탐색하는 과정이 필요했습니다.

이렇게 target 색상과 가장 가까운 색상을 검색 할 때 MongoDB내에 저장되어있는 모든 사진과의 유클리드 거리를 계산 해서 탐색한다면 불필요한 연산을 초래합니다. 이렇게 모든 사진을 탐색하게 된다면 소요 시간에도 영향을 미쳐 다음 사진의 랜더링이 그만큼 늦어지게 됩니다.

이를 해결하기 위해서 효율적으로 MongoDB내의 사진을 탐색할 수 있는 방법이 필요했습니다.
R, G, B 값은 0~255까지. 총 256개씩 3개의 축으로 구성되어있습니다. 아래는 matplotlib으로 678개의 데이터의 실제 분포를 나타낸 그린 3d 산점도 입니다.

DB내의 모든 사진과의 거리를 계산하지 않도록, 이 RGB 값을 구역으로 나누어서 target 색상과 가장 가까운 구역들에서만 유클리드 거리 공식으로 탐색하는 로직을 작성했습니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/a3cf9df9-7375-4c91-93bd-078d68f9e8e3/Untitled.png)

### 구역을 어떻게 나눌까?

1. R, G, B를 5구역씩 나눈다면?

만약 5구역으로 나누면 5*5*5 = 125개의 구역으로 구분하게 됩니다.

678개의 사진이 있기 떄문에 5개씩의 구역으로 나누게 되면, 분포가 일정하다는 가정하에 한 구역당 678/125 = 5개의 사진이 들어있게 되기 때문에 사진의 거리 계산을 해야할 사진의 양도 그 만큼 많아집니다.

2. 7구역씩 나눈다면?

7*7*7 = 343 개의 구역으로 나누는 방식입니다.

678개의 사진이 있기 때문에 7개씩의 구역으로 나누게 되면, 분포가 일정하다는 가정하에 한 구역당 평균적으로 678/343 = 2개의 사진이 들어있게 됩니다. 하지만 위의 3d 산점도에서와 같이, 밀도가 높은 영역이 있는 반면, 사진의 밀도가 낮은 영역도 존재합니다.

7개의 구역으로 나누면, 한 구역에 사진이 없을 확률도 높습니다. 이 경우, 구역 내에 어떤 사진도 없을 확률도 존재합니다. 즉, target 색상과 가장 유사한 사진을 검색할 수 없을 확률도 존재합니다.

3. 6구역씩 나눈다면?

따라서 6개의 구역으로 나누었습니다. 6*6*6 = 216개의 구역으로 나누면, 분포가 일정하다는 가정하에 평균적으로 678/216 = 3개의 사진이 들어있게 됩니다. 밀도의 불균일성을 고려하더라고 한 구역에 1개 이상이 있을 확률이 높기 때문에 6개의 구역으로 나누기로 결정했습니다.

### 해당하는 구역만 탐색하면 정확한 결과가 나오지 않는다

구역을 나누었을 때 같은 구역에 있는 사진들만 탐색한다면, 가장 유사한 색상의 사진이 나올 확률이 줄어듭니다. 같은 구역인 사진들 보다, 인접한 구역에 있는 사진들이 색상이 더 가까울 수 있기 때문입니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/abc93c0b-894e-407e-9bfa-b01cb7969195/Untitled.png)

위 도식은 2차원 공간에서 target 색상(분홍색)과 같은 구역인 사진 보다, 인접한 구역에 위치하는 색상이 더 거리가 가까울 수 있다는 것을 나타냅니다. 따라서 3차원 공간인 RGB에서는, 같은 구역 뿐만 아니라 그 구역과 인접하는 구역에 위치한 모든 사진의 유클리드 거리를 계산하여 가장 가까운 거리를 갖는 점을 찾아야 더 정확한 결과값을 얻을 수 있습니다. 즉, 최대 3*3*3 = 27개의 구역에 있는 점들 모두와 거리를 계산해 최소 거리를 갖는 사진을 찾습니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/42c8b137-ac4a-4dc3-b2a5-bd78195be4d0/Untitled.png)

이렇게 해당구역과, 그 구역을 둘러싼 구역들을 함께 탐색하면, 가장 색상이 유사한 사진을 탐색할 수 있습니다.

# 자료구조를 적용해서 탐색의 일관성을 높인다.

### 기존 방법의 문제점

위의 방법으로 구역을 나누어, 인접한 구역들의 사진들로 거리 계산하는 방식은 두 가지의 문제점이 있었습니다.

1. 사진을 더 많이 추가하게 되면, 지금처럼 6개의 구역으로 나누는 것이 적절하지 않을 수 있다.
2. 사진이 분포하는 정도에 따라, 밀도가 높은 구역에서는 탐색 시간이 오래 소요되고, 밀도가 낮은 구역에서는 탐색 시간이 상대적으로 적게 소요되는 현상.

첫번째 문제점을 보겠습니다, 지금은 6개의 구역으로 나눌 경우에 27개의 구역에 있는 사진이 많지 않기 때문에 사진을 추가해도 소요시간에 큰 차이는 없을 수 있습니다. 하지만 지금보다 훨씬 많은 사진을 추가하게 되는 상황이 발생한다면, 이렇게 인위적으로 구역을 나누는 방식이 좋지 않은 경우가 발생합니다.

두번째 문제점을 고려하면, 아래 3d 산점도에 표시한 영역들을 보면 분포가 일정하지 않아 상대적으로 밀도가 높은 구역과 낮은 구역이 존재하게 됩니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/a383bdac-43dc-4876-b44b-02b4d2c3cbcc/Untitled.png)

이와 같이 상대적으로 밀도가 높은 구역에는 탐색 시간이 많이 소요되게 되고, 밀도가 낮은 구역의 경우에는 탐색 시간이 적게 소요됩니다 .

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/a499d1d5-780e-48e4-b285-a43f40cdb1e5/fed62fa1-cd51-4ef7-b4d8-ee3012261b5e/Untitled.png)

위 사진은 실제로 탐색 시간을 측정한 결과입니다. 적게는 258에서부터 많게는 516까지 탐색 시간의 분포가 일관되지 않은 것을 볼 수 있습니다. 이 예시에서는 표준편차가 78.84로 계산 되었습니다. 이 처럼 탐색 시간이 일관되지 않다면, 신뢰성이 낮아집니다.
